# 카메라 상태 자동 기록 및 드롭박스 업로드 테스트 가이드

## 변경 사항 요약

1. **창 닫힘 시 자동 저장**: 마우스/키보드 이동 종료 시 저장하지 않고, 창이 닫힐 때 자동으로 저장됩니다.
2. **드롭박스 업로드**: 서버 API를 통해 드롭박스에 자동 업로드됩니다.

## 테스트 방법

### 1. 기본 기능 테스트 (로컬 저장)

#### 준비
1. 서버 실행 (선택사항 - 드롭박스 업로드 없이도 로컬 저장은 작동)
2. 브라우저에서 뷰어 열기

#### 테스트 단계
1. 모델 로드 (드롭박스 또는 로컬)
2. 마우스/터치로 카메라 이동 시작
   - 콘솔에 "카메라 상태 기록 시작" 메시지 확인
3. 카메라를 여러 번 이동 (회전, 줌, 팬)
   - 이동 중에는 자동으로 상태가 기록됨
4. **브라우저 탭 닫기** 또는 **브라우저 창 닫기**
   - 자동으로 JSON 파일이 다운로드됨
   - 또는 로컬 스토리지에 백업 저장됨

#### 확인 사항
- 콘솔에서 "카메라 상태 기록 시작" 메시지 확인
- 창 닫을 때 JSON 파일 다운로드 확인
- 다운로드된 JSON 파일 내용 확인 (states 배열에 여러 상태가 기록되어 있는지)

### 2. 드롭박스 업로드 테스트

#### 준비
1. `.env` 파일에 Dropbox 액세스 토큰 설정:
   ```
   dropbox.access.token=your_dropbox_access_token_here
   ```

2. Dropbox 액세스 토큰 발급 방법:
   - [Dropbox App Console](https://www.dropbox.com/developers/apps) 접속
   - 새 앱 생성 또는 기존 앱 선택
   - "Generated access token" 생성
   - 토큰을 `.env` 파일에 추가

3. 서버 실행:
   ```bash
   cd server
   npm install  # 필요한 경우
   node server.js
   ```

#### 테스트 단계
1. 드롭박스에서 모델 로드
   - 드롭박스 폴더 링크로 모델을 불러옴
   - 콘솔에서 "드롭박스 폴더 URL: ..." 메시지 확인

2. 카메라 이동
   - 마우스/터치로 카메라 이동
   - 여러 번 이동하여 상태 기록

3. 창 닫기
   - 브라우저 탭/창 닫기
   - 서버 콘솔에서 업로드 성공 메시지 확인:
     ```
     ✅ 카메라 상태 파일 업로드 성공: camera_states_2024-01-01T12-00-00.json
     ```

4. 드롭박스 확인
   - Dropbox 앱 또는 웹에서 확인
   - `/camera_states/` 폴더에 JSON 파일이 업로드되었는지 확인

#### 확인 사항
- 서버 콘솔에서 업로드 성공 메시지 확인
- 드롭박스에 파일이 실제로 업로드되었는지 확인
- 업로드된 JSON 파일 내용 확인

### 3. 로컬 스토리지 백업 테스트

#### 테스트 단계
1. 카메라 이동 후 창 닫기
2. 브라우저 개발자 도구 열기 (F12)
3. Application 탭 > Local Storage 확인
4. `last_camera_states` 키 확인
5. 값 확인 (JSON 문자열)

#### 복구 방법
```javascript
// 개발자 도구 콘솔에서 실행
const savedData = localStorage.getItem('last_camera_states');
const filename = localStorage.getItem('last_camera_states_filename');
console.log('저장된 파일명:', filename);
console.log('저장된 데이터:', JSON.parse(savedData));
```

### 4. 에러 케이스 테스트

#### 드롭박스 토큰 없음
- `.env` 파일에 토큰이 없거나 잘못된 경우
- 서버 콘솔에서 에러 메시지 확인
- 로컬 저장은 정상 작동해야 함

#### 네트워크 오류
- 인터넷 연결 끊기
- 서버 응답 지연
- 로컬 저장은 정상 작동해야 함

#### 드롭박스 권한 오류
- 토큰이 만료되었거나 권한이 없는 경우
- 서버에서 401 또는 403 에러 확인
- 로컬 저장은 정상 작동해야 함

## 디버깅 팁

### 콘솔 로그 확인
- `카메라 상태 기록 시작` - 기록 시작됨
- `카메라 상태 기록 중지: X개 상태 기록됨` - 기록 중지됨
- `드롭박스 폴더 URL: ...` - 드롭박스 URL 추출 성공
- `✅ 드롭박스 업로드 성공` - 업로드 성공
- `❌ 드롭박스 업로드 실패` - 업로드 실패

### 서버 로그 확인
- 업로드 요청 수신 확인
- Dropbox API 응답 확인
- 에러 메시지 확인

### 네트워크 탭 확인
- `POST /api/dropbox/upload-camera-states` 요청 확인
- 응답 상태 코드 확인 (200 = 성공)
- 요청/응답 본문 확인

## 문제 해결

### JSON 파일이 다운로드되지 않는 경우
- 브라우저 팝업 차단 확인
- 다운로드 폴더 확인
- 콘솔 에러 확인

### 드롭박스 업로드가 실패하는 경우
1. `.env` 파일에 토큰이 올바르게 설정되었는지 확인
2. 서버가 실행 중인지 확인
3. 서버 콘솔의 에러 메시지 확인
4. Dropbox 토큰 권한 확인 (files.content.write 필요)

### 기록이 시작되지 않는 경우
- ControlManager가 올바르게 초기화되었는지 확인
- 카메라 컨트롤이 활성화되어 있는지 확인
- 콘솔 에러 확인

## API 엔드포인트

### POST /api/dropbox/upload-camera-states

**요청 본문:**
```json
{
  "folderId": "abc123",
  "filename": "camera_states_2024-01-01T12-00-00.json",
  "data": "{ ... JSON 문자열 ... }"
}
```

**성공 응답 (200):**
```json
{
  "success": true,
  "path": "/camera_states/camera_states_2024-01-01T12-00-00.json",
  "shareLink": "https://www.dropbox.com/s/...",
  "message": "카메라 상태 파일이 드롭박스에 업로드되었습니다."
}
```

**에러 응답 (400/500):**
```json
{
  "message": "에러 메시지",
  "error": "상세 에러 정보"
}
```

